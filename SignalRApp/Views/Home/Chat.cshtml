@using Microsoft.AspNet.Identity

@{
    ViewBag.Title = "Chat";
}
@section styles{

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="~/Content/chat.css" rel="stylesheet" />

}
<input type="hidden" value="@User.Identity.GetUserName()" id="currentUser" />

<div class="container">
    <div class="col-md-4 col-lg-3">

        <div class="panel">
            <!--Heading-->
            <div class="panel-heading">
                <div class="panel-control">
                    <div class="btn-group">
                        <button class="btn btn-default" type="button" data-toggle="collapse" data-target="#demo-online-body"><i class="fa fa-chevron-down"></i></button>
                        <button type="button" class="btn btn-default" data-toggle="dropdown"><i class="fa fa-gear"></i></button>
                        <ul class="dropdown-menu dropdown-menu-right">
                            @*<li><a href="#">Available</a></li>
                                <li><a href="#">Busy</a></li>
                                <li><a href="#">Away</a></li>
                                <li class="divider"></li>
                                <li><a id="demo-connect-chat" href="#" class="disabled-link" data-target="#demo-chat-body">Connect</a></li>
                                <li><a id="demo-disconnect-chat" href="#" data-target="#demo-chat-body">Disconect</a></li>*@

                        </ul>
                    </div>
                </div>
                <h3 class="panel-title">Online</h3>
            </div>

            <!--Widget body-->
            <div id="demo-online-body" class="collapse in">
                <div class="nano has-scrollbar" style="height:380px">
                    <div class="nano-content pad-all" tabindex="0" style="right: -17px;">
                        <ul class="list-unstyled media-block">
                            @*<li class="mar-btm">
                                    <div class="media-left">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor">
                                        <div class="speech">
                                            <a href="#" class="media-heading">John Doe</a>

                                        </div>
                                    </div>
                                </li>*@


                        </ul>
                    </div>
                    <div class="nano-pane"><div class="nano-slider" style="height: 141px; transform: translate(0px, 0px);"></div></div>
                </div>

                <!--Widget footer-->

            </div>

            <div class="panel-footer">
                <div class="row">
                    to : <input type="text" name="selectedUser" id="selectedUser" value="all" />
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8 col-lg-9">
        <div class="panel">
            <!--Heading-->
            <div class="panel-heading">
                <div class="panel-control">
                    <div class="btn-group">
                        <button class="btn btn-default" type="button" data-toggle="collapse" data-target="#demo-chat-body"><i class="fa fa-chevron-down"></i></button>
                        <button type="button" class="btn btn-default" data-toggle="dropdown"><i class="fa fa-gear"></i></button>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li><a href="#">Available</a></li>
                            <li><a href="#">Busy</a></li>
                            <li><a href="#">Away</a></li>
                            <li class="divider"></li>
                            <li><a id="demo-connect-chat" href="#" class="disabled-link" data-target="#demo-chat-body">Connect</a></li>
                            <li><a id="demo-disconnect-chat" href="#" data-target="#demo-chat-body">Disconect</a></li>
                        </ul>
                    </div>
                </div>
                <h3 class="panel-title">Chat</h3>
            </div>

            <!--Widget body-->
            <div id="demo-chat-body" class="collapse in">
                <div class="nano has-scrollbar" style="height:380px">
                    <div class="nano-content pad-all" tabindex="0" style="right: -17px;">
                        <ul class="list-unstyled media-block">
                            @*<li class="mar-btm">
                                    <div class="media-left">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor">
                                        <div class="speech">
                                            <a href="#" class="media-heading">John Doe</a>
                                            <p>Hello Lucy, how can I help you today ?</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i>09:23AM
                                            </p>
                                        </div>
                                    </div>
                                </li>
                                <li class="mar-btm">
                                    <div class="media-right">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar2.png" class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor speech-right">
                                        <div class="speech">
                                            <a href="#" class="media-heading">Lucy Doe</a>
                                            <p>Hi, I want to buy a new shoes.</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i> 09:23AM
                                            </p>
                                        </div>
                                    </div>
                                </li>*@

                        </ul>
                    </div>
                    <div class="nano-pane"><div class="nano-slider" style="height: 141px; transform: translate(0px, 0px);"></div></div>
                </div>

                <!--Widget footer-->
                <div class="panel-footer">
                    <div class="row">
                        <div class="col-xs-3">
                            Broadcast : <input type="checkbox" id="broadcast" />
                        </div>
                        <div class="col-xs-7">
                            <input type="text" id="message" placeholder="Enter your text" class="form-control chat-input">
                        </div>

                        <div class="col-xs-2">
                            <button class="btn btn-primary btn-block" id="sendmessage" type="button">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>




@section scripts{


    <script src="~/Scripts/jquery.signalR-2.4.0.js"></script>
    @*Remove if not using proxy*@
    @*<script src="~/signalr/hubs"></script>*@
    <script>

        $(function () {
            let currentUser = "@User.Identity.GetUserName()";

            //// with generated proxy
            //let chat = $.connection.chatHub;
            //chat.client.broadcastMessage = function (name, message) {
            //    appendMessage(name, message);
            //}

            //$.connection.hub.start().done(function(){
            //    console.log('Now connected, connection ID=' + $.connection.hub.id);
            //    $('#sendmessage').click(function () {
            //        chat.server.send($('#currentUser').val(), $('#message').val());
            //        $('#message').val('').focus();
            //    });

            //});

            //// without generated proxy
            let connection = $.hubConnection();
            connection.qs = { "username": currentUser }
            let chatHubProxy = connection.createHubProxy('chatHub');
            connection.start()
                    .done(init)
                    .fail(() => console.log('Could not Connect!'));
            // functions invoked from server
            chatHubProxy.on('broadcastMessage', appendMessage);
            chatHubProxy.on('newMessage', appendMessage);
            chatHubProxy.on('userJoinOrLeave', updateUsers)
            // invoke server function
            function init() {
                console.log('connected, connection ID=' + connection.id);
                $('#sendmessage').click(function () {
                    if ($('#broadcast').is(':checked') || $('#selectedUser').val() === 'all')
                        chatHubProxy.invoke('send', $('#currentUser').val(), $('#message').val());
                    else
                        chatHubProxy.invoke('send', $('#currentUser').val(), $("#selectedUser").val(), $('#message').val());

                });
            }


            function appendMessage(name, message) {
                $('#demo-chat-body .list-unstyled')
                    .append(
                    `
                    <li class="mar-btm">
                                <div class =" ${name === currentUser ? 'media-right' : 'media-left'}">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="img-circle img-sm" alt="Profile Picture">
                                </div>
                                <div class ="media-body pad-hor ${name === currentUser ? 'speech-right' : ''}">
                                    <div class="speech">
                                        <a href="#" class ="media-heading">${name} <span class ="speech-time"> <i class ="fa fa-clock-o fa-fw"></i>09:23AM</span></a>
                                        <p>${message}</p>
                                    </div>
                                </div>
                            </li>
                ` );
            }

            function updateUsers() {
                $.getJSON('/Home/GetConnectedIds', {}, function (users) {
                    //console.log(users);
                    $('#demo-online-body .list-unstyled').empty();
                    for (let user in users) {
                        if(user !== currentUser){
                            $('#demo-online-body .list-unstyled')

                        .append(
                        `
                    <li class="mar-btm">
                                <div class ="media-left">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="img-circle img-sm" alt="Profile Picture">
                                </div>
                                <div class ="media-body pad-hor">
                                    <div class="speech">
                                        <a href="#" class ="media-heading">${user}</a>
                                    </div>
                                </div>
                            </li>
                `);
                        }
                        
                    }
                });
            }

            $('#demo-online-body').on('click','a',function () {
                debugger;
                let selectedUser = $(this).text();
                $('#selectedUser').val(selectedUser);
            });
        });


    </script>


}